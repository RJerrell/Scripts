cls

$outputPath = "C:\KC46 Staging\scripts\Report Generators\Outputs"
$reportName = "Data Modules Search Report - Support Equipment Listing for Richard Trach - Report 3"
#[System.Collections.ArrayList] $stringToLookup = @("762-17831-1","G28035-2","RMA100001-1","5TSFFT1T2849-9","C28002-9","2MIT143T0390","MIT140T0395","MIT140T0397","MIT143T0390","5TSFFT1T2820-2","5TSFFT1T2910-4","5TSFFT1T2616-1","5TSFFT1T2814-4","TSFFT1T2621","FPME453T1272","MIT143T0390-1","MIT842-349866","MIT842-349210","MA280004-1","3ME143T0390","2ME143T0390","ME143T0390","OHME143T0390","ME842-349214","OHME842-349510","OHME842-349710","MIT842-349521","F72849-1","ST2580-177","ST2580-381A-15","ST895A-3","ST8709H-X","ST8744","G26004-65","G26004-66","F72959-35","F72959-33")
#[System.Collections.ArrayList] $seNumsNotReferenced = @("762-17831-1","G28035-2","RMA100001-1","5TSFFT1T2849-9","C28002-9","2MIT143T0390","MIT140T0395","MIT140T0397","MIT143T0390","5TSFFT1T2820-2","5TSFFT1T2910-4","5TSFFT1T2616-1","5TSFFT1T2814-4","TSFFT1T2621","FPME453T1272","MIT143T0390-1","MIT842-349866","MIT842-349210","MA280004-1","3ME143T0390","2ME143T0390","ME143T0390","OHME143T0390","ME842-349214","OHME842-349510","OHME842-349710","MIT842-349521","F72849-1","ST2580-177","ST2580-381A-15","ST895A-3","ST8709H-X","ST8744","G26004-65","G26004-66","F72959-35","F72959-33")
[System.Collections.ArrayList] $stringToLookup = @("MA260001-90","J28010-139","MA280020-25","MA280019-143","4MIT65B80307-1","MA280013-134","A32099-112","MA280057-1","ST2589A-1","A32036-67","MA280034-1","MA280037-1","MA280056-1","MA280012-39","MA200001-60","A71003-53","MA240001-40","J21009-48","A21010-203","MA200002-1","MA200003-1","MA200004-1","MA280014-24","A20008-1","A07007-33","A20001-152","A28003-90","A27027-59","A28005-24","A31007-59","A20005-9","A20006-32","762-17831-2","762-17831-1","C10004-1","A27118-111","A55008-1","A32039-1","A32073-1","A32006-77","A32008-51","A27001-1","A27001-2","A27001-3","A27001-4","F72951-1","J28011-7","A29001-20","G28035-2","RMA100001-1","A21014-1","A25020-8","A30004-1","A38003-30","J52024-24","A49004-24","A27007-19","A20002-29","A78002-1","MA240002-1","MA380001-1","A32069-7","J28011-205","A24005-1","B29001-46","B29001-23","J28013-1","F70284-1","A52035-1","A32086-1","A32094-1","A32100-1","A21009-1","J20009-70","A52025-1","A32123-1","A38005-1","A32055-1","A32074-1","A32032-65","A32038-23","A32027-53","A27092-106","A32032-64","A25009-2","A32028-6","A32030-21","A49003-12","A49009-1","A32011-1","A32013-1","A32026-60","A32017-1","A32020-1","A32023-1","A32010-1","A27129-1","A12001-14","A27021-98","A27088-18","A71015-108","A32005-74","A27112-1","A27110-20","A27111-11","A56001-15","A28005-50","A49001-137","A49001-83","A28008-8","A30002-1","A27109-1","A27095-10","A27099-1","A27101-5","A27102-7","A27105-9","A27106-1","A27108-13","A27110-1","A27063-91","A27094-5","A25012-29","A27077-1","A27089-9","A27015-1","A27016-27","A27017-41","A27019-8","A27020-1","A27013-1","A27022-81","A27023-22","A27024-55","A27026-7","A27057-13","A27009-7","A12008-1","A24007-1","A27004-1","A27004-2","A27006-41","A07001-11","A07002-11","A07003-1","A12007-23","MA240004-1","A27005-1","J32060-1","A32035-1","A10002-9","MA350001-1","MA470005-1","MA520003-1","A32075-10","5TSFFT1T2849-9","A20001-65","C28002-9","2MIT143T0390","MIT140T0395","MIT140T0397","MIT143T0390","5TSFFT1T2820-2","MA280028-1","A32045-91","MA280027-1","MA280024-1","MA070004-31","5TSFFT1T2910-4","5TSFFT1T2616-1","5TSFFT1T2814-4","A38001-22","TSFFT1T2621","MA520002-1","MA280009-1","A38006-1","A38007-9","A38009-11","A32015-9","MA280010-1","MA990001-1","A49002-2","5TSFFT1T2849-10","FPME453T1272","MA280002-1","MIT143T0390-1","MA280021-1","MA280025-1","MIT842-349866","MA280022-1","MIT842-349210","MA280005-1","MA280004-1","MA280008-1","MA530003-1","MA510001-1","MA280003-1","3ME143T0390","MA280011-1","MA280015-1","MA120001-1","MA070004-1","MA280001-1","A71008-65","MA460001-1","2ME143T0390","A07008-25","A07008-29","MA310001-1","ME143T0390","OHME143T0390","MA280017-1","MA280018-1","MA280006-1","ME842-349214","ME842-349621","OHME842-349510","OHME842-349710","A38001-68","MA280007-1","MA280016-1","MIT842-349521","MA470001-1","MA070002-1","MA070003-1","J52039-87","J52039-88","J52039-90","G25012-8","A27117-1","MA070001-1","B28009-1","MA260004-1","MA260003-1","B52004-1","MA710001-1","MA250001-1","B71044-28","A32030-18","A28012-1","A29002-6","C32051-1","C34012-2","C38001-29","F70200-18","F70206-1","A32004-1","A32021-1","F71300","F71329","A24011-1","A52034-1","A78001-31","F72849-1","G78005-10","F80212-30","ST2580-177","A21013-50","J52039-1","ME65B83635","ST2580-381","G28005-35","G28014-15","ST2580-381A-15","J51004-1","A07010-1","G38004-13","G38006-1","A71001-191","A71005-33","A71030-32","J20002-59","A71032-14","A71042-29","J24015-1","A78003-41","A32045-87","A32045-12","A32045-34","A32045-48","A54011-25","A52016-1","G24006-1","J24016-1","J27079-38","J34002-19","B54001-53","B71034-29","G71020-1","J07008-30","A27125-17","A32101-1","A51002-1","A51005-14","A55001-47","A71049-1","B28005-41","A27124-1","A28013-10","A32092-1","A32095-1","A32097-1","A32098-12","A36001-45","A27107-1","A27122-1","A27128-1","A20001-83","A25019-1","A71016-1","A21012-1","A24004-2","A24008-37","A25003-24","A25005-29","A25011-2","A25014-29","A25016-1","A12004-40","ST895A-3","ST8709H-X","ST8744","A52033-1","A52036-1","J28006-1","J28007-10","J28007-9","G34004-17","G26004-65","G26004-66","F72959-35","F72959-41","F70328-1","A36005-15","A52030-1","C28013-6","G28018-28","A32029-50","A32031-5","A32034-1","A32012-13","A52020-1","A52022-1","A52031-1","A52032-17","A53002-5","A57008-1","B28001-18","A52008-14","A52013-31","A52019-1","A52029-1","A53001-14","A54001-167","A52002-13","A52003-1","A52004-41","A52004-43","A52005-18","MIT65B92408-1","A49005-12","A32065-1","A32079-1","A32082-1","A32096-70","A32046-17","2ME65B00002","A27003-23","A27012-30","A20004-78","F72959-33","A49001-84","A27024-31","ST879AF","A32016-17","A32098-1")
[System.Collections.ArrayList] $seNumsNotReferenced = @("MA260001-90","J28010-139","MA280020-25","MA280019-143","4MIT65B80307-1","MA280013-134","A32099-112","MA280057-1","ST2589A-1","A32036-67","MA280034-1","MA280037-1","MA280056-1","MA280012-39","MA200001-60","A71003-53","MA240001-40","J21009-48","A21010-203","MA200002-1","MA200003-1","MA200004-1","MA280014-24","A20008-1","A07007-33","A20001-152","A28003-90","A27027-59","A28005-24","A31007-59","A20005-9","A20006-32","762-17831-2","762-17831-1","C10004-1","A27118-111","A55008-1","A32039-1","A32073-1","A32006-77","A32008-51","A27001-1","A27001-2","A27001-3","A27001-4","F72951-1","J28011-7","A29001-20","G28035-2","RMA100001-1","A21014-1","A25020-8","A30004-1","A38003-30","J52024-24","A49004-24","A27007-19","A20002-29","A78002-1","MA240002-1","MA380001-1","A32069-7","J28011-205","A24005-1","B29001-46","B29001-23","J28013-1","F70284-1","A52035-1","A32086-1","A32094-1","A32100-1","A21009-1","J20009-70","A52025-1","A32123-1","A38005-1","A32055-1","A32074-1","A32032-65","A32038-23","A32027-53","A27092-106","A32032-64","A25009-2","A32028-6","A32030-21","A49003-12","A49009-1","A32011-1","A32013-1","A32026-60","A32017-1","A32020-1","A32023-1","A32010-1","A27129-1","A12001-14","A27021-98","A27088-18","A71015-108","A32005-74","A27112-1","A27110-20","A27111-11","A56001-15","A28005-50","A49001-137","A49001-83","A28008-8","A30002-1","A27109-1","A27095-10","A27099-1","A27101-5","A27102-7","A27105-9","A27106-1","A27108-13","A27110-1","A27063-91","A27094-5","A25012-29","A27077-1","A27089-9","A27015-1","A27016-27","A27017-41","A27019-8","A27020-1","A27013-1","A27022-81","A27023-22","A27024-55","A27026-7","A27057-13","A27009-7","A12008-1","A24007-1","A27004-1","A27004-2","A27006-41","A07001-11","A07002-11","A07003-1","A12007-23","MA240004-1","A27005-1","J32060-1","A32035-1","A10002-9","MA350001-1","MA470005-1","MA520003-1","A32075-10","5TSFFT1T2849-9","A20001-65","C28002-9","2MIT143T0390","MIT140T0395","MIT140T0397","MIT143T0390","5TSFFT1T2820-2","MA280028-1","A32045-91","MA280027-1","MA280024-1","MA070004-31","5TSFFT1T2910-4","5TSFFT1T2616-1","5TSFFT1T2814-4","A38001-22","TSFFT1T2621","MA520002-1","MA280009-1","A38006-1","A38007-9","A38009-11","A32015-9","MA280010-1","MA990001-1","A49002-2","5TSFFT1T2849-10","FPME453T1272","MA280002-1","MIT143T0390-1","MA280021-1","MA280025-1","MIT842-349866","MA280022-1","MIT842-349210","MA280005-1","MA280004-1","MA280008-1","MA530003-1","MA510001-1","MA280003-1","3ME143T0390","MA280011-1","MA280015-1","MA120001-1","MA070004-1","MA280001-1","A71008-65","MA460001-1","2ME143T0390","A07008-25","A07008-29","MA310001-1","ME143T0390","OHME143T0390","MA280017-1","MA280018-1","MA280006-1","ME842-349214","ME842-349621","OHME842-349510","OHME842-349710","A38001-68","MA280007-1","MA280016-1","MIT842-349521","MA470001-1","MA070002-1","MA070003-1","J52039-87","J52039-88","J52039-90","G25012-8","A27117-1","MA070001-1","B28009-1","MA260004-1","MA260003-1","B52004-1","MA710001-1","MA250001-1","B71044-28","A32030-18","A28012-1","A29002-6","C32051-1","C34012-2","C38001-29","F70200-18","F70206-1","A32004-1","A32021-1","F71300","F71329","A24011-1","A52034-1","A78001-31","F72849-1","G78005-10","F80212-30","ST2580-177","A21013-50","J52039-1","ME65B83635","ST2580-381","G28005-35","G28014-15","ST2580-381A-15","J51004-1","A07010-1","G38004-13","G38006-1","A71001-191","A71005-33","A71030-32","J20002-59","A71032-14","A71042-29","J24015-1","A78003-41","A32045-87","A32045-12","A32045-34","A32045-48","A54011-25","A52016-1","G24006-1","J24016-1","J27079-38","J34002-19","B54001-53","B71034-29","G71020-1","J07008-30","A27125-17","A32101-1","A51002-1","A51005-14","A55001-47","A71049-1","B28005-41","A27124-1","A28013-10","A32092-1","A32095-1","A32097-1","A32098-12","A36001-45","A27107-1","A27122-1","A27128-1","A20001-83","A25019-1","A71016-1","A21012-1","A24004-2","A24008-37","A25003-24","A25005-29","A25011-2","A25014-29","A25016-1","A12004-40","ST895A-3","ST8709H-X","ST8744","A52033-1","A52036-1","J28006-1","J28007-10","J28007-9","G34004-17","G26004-65","G26004-66","F72959-35","F72959-41","F70328-1","A36005-15","A52030-1","C28013-6","G28018-28","A32029-50","A32031-5","A32034-1","A32012-13","A52020-1","A52022-1","A52031-1","A52032-17","A53002-5","A57008-1","B28001-18","A52008-14","A52013-31","A52019-1","A52029-1","A53001-14","A54001-167","A52002-13","A52003-1","A52004-41","A52004-43","A52005-18","MIT65B92408-1","A49005-12","A32065-1","A32079-1","A32082-1","A32096-70","A32046-17","2ME65B00002","A27003-23","A27012-30","A20004-78","F72959-33","A49001-84","A27024-31","ST879AF","A32016-17","A32098-1")

$objs =  @()

[string[]] $PubList   = @("KC46","ACS","AMM","ARD","FIM","IPB","LOAPS","NDT","SIMR","SPCC","SSM","SWPM", "TC","WUC","WDM")
$pbTaskXML = New-Object System.Xml.XmlDocument
$pbTaskXMLpath = "C:\KC46 Staging\Scripts\Report Generators\Outputs\PBTask to DMC Map.xml"
$pbTaskXML.Load($pbTaskXMLpath)
$rows = $pbTaskXML.Objs.S
foreach ($pub in $Publist)
{
    #Limited to Installation Procedures
    $inputPath = "C:\KC46 Staging\production\Manuals\$pub\S1000D\SDLLIVE\dmc-*"
    $files = gci -Path  $inputPath -Verbose
    foreach ($file in $files)
    {
        $fn = $file.Name
        
        $pbTask = ""
        foreach ($row in $rows)
        {
            if($row.Contains($fn))
            {
                $rArray = $row.Split("|")
                $pbTask = $rArray[1].ToString()
            }
        }

        $sr = New-Object System.IO.StreamReader($file.FullName)
        $c = $sr.ReadToEnd()
        $sr.Dispose()
        $save = $false
        $list = ""
        
        foreach ($string in $stringToLookup)
        {
            if($c -match $string)
            {
                $save = $true
                $list += $string + "|"
                $seNumsNotReferenced.Remove($string)
            }                
        }
        if($list -ne "")
        {        
            $list = $list.Substring(0, $list.Length -1)
        }
        if($save)
        {
            $FN = $file.Name
            $DMC = [xml] (Get-Content -Path $file -Raw)
            $techName = $DMC.DocumentElement.identAndStatusSection.dmAddress.dmAddressItems.dmTitle.techName
            $infoName = $DMC.DocumentElement.identAndStatusSection.dmAddress.dmAddressItems.dmTitle.infoName
            $obj = [pscustomobject][ordered]@{PBTask=$pbTask;DMC=$FN;TechName=$techName;InfoName=$infoName;Contains=$list;}
            $objs += $obj
            $obj=$null
        }        
    }
}

# Define the sort properties for the report
$prop1 = @{Expression='DMC'; Ascending=$true }
$prop2 = @{Expression='TechName'; Ascending=$true }


# Store the report
$objs.GetEnumerator() | Sort-Object -Property $prop1 | Export-Csv "$outputPath\$reportName - Sorted by DMC.csv" -NoTypeInformation 
$objs.GetEnumerator() | Sort-Object -Property $prop2 | Export-Csv "$outputPath\$reportName - Sorted by TechName.csv" -NoTypeInformation

$seNumsNotReferenced | %{$_} |fl